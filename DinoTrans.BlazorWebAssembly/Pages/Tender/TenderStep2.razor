@inject IConstructionMachineService ConstructionMachineService
@inject IJSRuntime js
<div class="card-body">
    <EditForm Model="InputStep2">
        <div class="column">
            @* Thời gian nhận hàng và thời gian giao hàng *@
            <div class="col-md-12 row">
                <div class="form-group col-md-6 column">
                    <header>Thời gian nhận hàng</header>
                    <div class="col-md-12">                
                        <label class="form-label">
                            Ngày nhận  hàng*
                        </label>
                        <input type="date" @bind="InputStep2.PickUpDate" class="form-control" @oninput="SearchOnInputChange" />
                        @* @if (ErrorStartDate != null)
                        {
                            <div style="color:red">@ErrorStartDate</div>
                        } *@
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">
                            Giờ nhận  hàng*
                        </label>
                        <input type="time" @bind="InputStep2.PickUpTime" class="form-control" @oninput="SearchOnInputChange" />
                        @* @if (ErrorStartDate != null)
                        {
                            <div style="color:red">@ErrorEndDate</div>
                        } *@
                    </div>
                </div>
                <div class="form-group col-md-6 column">
                    <header>Thời gian giao hàng</header>
                    <div class="col-md-12">
                        <label class="form-label">
                            Ngày giao hàng*
                        </label>
                        <input type="date" @bind="InputStep2.DeliveryDate" class="form-control" @oninput="SearchOnInputChange" />
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">
                            Giờ giao hàng *
                        </label>
                        <input type="time" @bind="InputStep2.DeliveryTime" class="form-control" @oninput="SearchOnInputChange" />
                    </div>
                </div>
            </div>
            @*  Máy cần vận chuyển *@
            <div class="col-md-12">
                <div class="row">
                    <header class="col-md-6">Thông tin máy xây dựng</header>
                    <NewConstructionMachineDialog IsDefaultEvent=IsDefaultEvent CallDefaultEvent=HandleDefaultEvent addedmachine="recallAPI" CompanyId="CompanyId"></NewConstructionMachineDialog>
                </div>                
            </div>
            <div>
                <input type="text" class="form-control" value="@searchText"
                       @onchange="@((ChangeEventArgs e) => ChangeText(e))"
                       placeholder="Search for construction machinery & equipment..." />
            </div>
            <ContructionMachineList constructionMachinesListChooses="contructionMachinesChoose"></ContructionMachineList>
            <div class="float-end">
                <Pagination ActivePageNumber="@currentPageNumber"
                            TotalPages="TotalPage"
                            DisplayPages="2"
                            FirstLinkIcon="IconName.ChevronDoubleLeft"
                            PreviousLinkIcon="IconName.ChevronLeft"
                            NextLinkIcon="IconName.ChevronRight"
                            LastLinkIcon="IconName.ChevronDoubleRight" 
                            PageChanged="OnPageChangedAsync" />
            </div>
            @*Địa chỉ và liên lạc nhận hàng và giao hàng*@
            <div class="col-md-12 row">
                <div class="form-group col-md-6 column">
                    <header>Thông tin nhận hàng</header>
                    <div class="col-md-12">
                        <label class="form-label">
                            Địa chỉ nhận hàng *
                        </label>
                        <input type="text" @bind="InputStep2.PickUpAddress" class="form-control" />
                        @* @if (ErrorStartDate != null)
                        {
                        <div style="color:red">@ErrorStartDate</div>
                        } *@
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">
                            Liên hệ nhận hàng *
                        </label>
                        <input type="text" @bind="InputStep2.ContactAtPickUpAddress" class="form-control" />
                        @* @if (ErrorStartDate != null)
                        {
                        <div style="color:red">@ErrorEndDate</div>
                        } *@
                    </div>
                </div>
                <div class="form-group col-md-6 column">
                    <header>Thông tin giao hàng</header>
                    <div class="col-md-12">
                        <label class="form-label">
                            Địa chỉ giao hàng *
                        </label>
                        <input type="text" @bind="InputStep2.DeliveryAddress" class="form-control" />
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">
                            Liên hệ giao hàng *
                        </label>
                        <input type="text" @bind="InputStep2.ContactAtDeliveryAddress" class="form-control" />
                    </div>
                </div>
            </div>

            @*Ghi chú và tài liệu*@
            <div class="col-md-12 row">
                    <header>Mô tả và tài liệu đính kèm</header>

                    <div class="col-md-6">
                        <label class="form-label">
                            Mô tả *
                        </label>
                        <textarea type="text" @bind="InputStep2.Notes" class="form-control" />
                        @* @if (ErrorStartDate != null)
                        {
                        <div style="color:red">@ErrorStartDate</div>
                        } *@
                    </div>

                    <div class="col-md-6">
                        <span>
                            <label class="form-label">
                                Tài liệu đính kèm *
                            </label>
                        <label class="btn btn-outline-success float-end" style="position: relative; overflow: hidden;">
                            <span>+ Upload a document</span>
                            <InputFile id="fileInput" OnChange="@HandleFileSelection" multiple style="opacity: 0; width: 150px; height: 150px; position: absolute; top: 0; left: 0; cursor: pointer; z-index: 2;" />
                        </label>
                        </span>
                        <div class="mt-3">
                            @if (selectedFiles != null && selectedFiles.Count > 0)
                            {
                                @foreach (var file in selectedFiles)
                                {
                                    <tr>
                                        <td style="padding-right:10px">@file.Name</td>
                                        <td>
                                            <button class="btn btn-outline-danger" @onclick="() => RemoveDocument(file)">- Remove from Tender</button>
                                        </td>
                                    </tr>
                                }
                            }
                        </div>
                    </div>
             </div> 
        </div>

        <div class="form-group row float-end me-4">
            <button class="btn btn-primary mt-4" type="submit" @onclick="OnHandleSubmit">Bước tiếp theo</button>
        </div>
    </EditForm>
</div>
@code {
    [Parameter]
    public DinoTrans.Shared.Entities.Tender? NewTender { get; set; } = null;
    [Parameter]
    public int CompanyId { get; set; }
    public ConvertStep2 InputStep2 { get; set; } = new();
    public SearchLoadForTenderDTO searchLoadForTenderDTO = new();
    public List<ContructionMachine> contructionMachines = new();
    public List<ConstructionMachinesListChoose> contructionMachinesChoose = new();
    public int TotalPage { get; set; }
    public int currentPageNumber = 1;
    public string searchText { get; set; } = "";
    public bool IsDefaultEvent { get; set; } = false;
    public string ErrorDisplay = "";
    public CreateContructionMachineDTO newConstructionMachine { get; set; }
    List<InputFileData> selectedFiles = new List<InputFileData>();
    public class InputFileData
    {
        public string Name { get; set; }
        public byte[] Data { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await SearchOnInputChange();
        var endDateString = NewTender!.EndDate.ToString("yyyy-MM-dd");
        DateOnly enddateOnly = DateOnly.Parse(endDateString);
        InputStep2.PickUpDate = enddateOnly.AddDays(1);
        InputStep2.DeliveryDate = enddateOnly.AddDays(1);
        InputStep2.PickUpTime = new();
        InputStep2.DeliveryTime = InputStep2.PickUpTime.AddHours(1);
        InputStep2.PickUpAddress = "";
        InputStep2.DeliveryAddress = "";
        InputStep2.ContactAtPickUpAddress = "";
        InputStep2.ContactAtDeliveryAddress = "";
        InputStep2.Notes = "";
        InputStep2.Documentations = "";
    }

    public async void HandleFileSelection(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var buffer = new byte[file.Size];
            try
            {
                await file.OpenReadStream().ReadAsync(buffer);
            }catch(Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
            selectedFiles.Add(new InputFileData { Name = file.Name, Data = buffer });
        }
        StateHasChanged();
    }

    public void RemoveDocument(InputFileData input)
    {
        selectedFiles.Remove(input);
        StateHasChanged();
    }

    private async void OnHandleSubmit()
    {
        if (contructionMachinesChoose == null || contructionMachinesChoose.Count == 0)
        {
            ErrorDisplay = "Please choose construction machine";
            await js.InvokeVoidAsync("alert", ErrorDisplay);
        }
    }

    private async Task SearchOnInputChange()
    {
        try
        {
            DateTime startDate = DateTime.Parse($"{InputStep2.PickUpDate} {InputStep2.PickUpTime}");
            DateTime endDate = DateTime.Parse($"{InputStep2.DeliveryDate} {InputStep2.DeliveryTime}");
            searchLoadForTenderDTO = new SearchLoadForTenderDTO
            {
                pageIndex = currentPageNumber,
                pageSize = 5,
                SearchText = searchText,
                TenderId = NewTender.Id,
                PickUpDate = startDate,
                DeliveryDate = endDate
            };
            var response = await ConstructionMachineService.SearchConstructionMachineForTender(searchLoadForTenderDTO);
            if(response.Success)
            {
                contructionMachines = response.Data.contructionMachines;
                contructionMachinesChoose = new();
                foreach (var item in contructionMachines)
                {
                    contructionMachinesChoose.Add(new ConstructionMachinesListChoose
                    {
                        Id = item.Id,
                        Name = item.Name,
                        Brand = item.Brand,
                        SerialNumber = item.SerialNumber,
                        CompanyShipperId = item.CompanyShipperId,
                        Image = item.Image,
                        Length = item.Length,
                        Width = item.Width,
                        Height = item.Height,
                        Weight = item.Weight
                    });
                }
                TotalPage = response.Data.TotalPage;
            }
        }catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task OnPageChangedAsync(int newPageNumber)
    {
        await Task.Run(() => { currentPageNumber = newPageNumber; });
        await SearchOnInputChange();
    }

    private async Task recallAPI()
    {
        await SearchOnInputChange();
    }

    private async Task ChangeText(ChangeEventArgs e)
    {
        IsDefaultEvent = true;
        searchText = e?.Value.ToString();
        await SearchOnInputChange();
    }

    public void HandleDefaultEvent(bool newStatus)
    {
        IsDefaultEvent = newStatus;
    }
}
